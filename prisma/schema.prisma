generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  user_id            String          @id @default(cuid())
  name               String?
  email              String?         @unique
  phone              String?         @unique
  password           String          @default("") 
  dob                String? 
  blood_group        String?

  // New Columns added to User
  city               String?
  state              String?
  pin_code           String?
  country            String? 

  // Plan Status
  plan_status        String          @default("inactive")
  subscription_count Int             @default(0) 

  // Address Relations
  addresses          Address[]       @relation("UserAddresses")

  subscription       SubscribedUser?

  // Family Members Relation
  members            Member[]

  // Orders Relation
  orders             Order[]

  // Allowed numbers added by / owned by this user
  allowed_numbers    AllowedNumber[]

  wishlist         Wishlist[]
  cart             Cart[]

  created_at         DateTime        @default(now())
  updated_at         DateTime        @updatedAt
}

model SubscribedUser {
  subscription_id String   @id @default(cuid()) // Int se String (cuid)
  user_id         String   @unique
  user            User     @relation(fields: [user_id], references: [user_id])
  plan_name       String   @default("S2S Premium")
  amount          Float    @default(2999.0)
  start_date      DateTime @default(now())
  end_date        DateTime
  status          String   @default("active")
  order_id        String   @default("no_id") 
  payment_id      String   @default("no_id")
}

model Address {
  address_id       String  @id @default(cuid()) // Int se String (cuid)
  user             User    @relation("UserAddresses", fields: [user_id], references: [user_id])
  user_id          String
  address_line     String?
  city             String?
  state            String?
  country          String? @default("India")
  pin_code         String?
  label            String?
  lat              Float?
  lon              Float?
  plan_status       String   @default("active")
  orders           Order[]
  created_at       DateTime @default(now())

@@index([user_id])
}

model Member {
  member_id       String          @id @default(cuid())
  name            String
  dob             String?         // Format: DD/MM/YYYY
  blood_group     String?
  phone           String?
  plan_status     String          @default("active")
  user_id         String?
  user            User?           @relation(fields: [user_id], references: [user_id])
  
  orders          Order[]
  allowed_numbers AllowedNumber[]
  created_at      DateTime        @default(now())

@@index([user_id])
}

model Order {
  order_id            String   @id @default(cuid())
  user_id             String
  user                User     @relation(fields: [user_id], references: [user_id])
  member_id           String?
  member              Member?  @relation(fields: [member_id], references: [member_id])
  admin_id            String? 
  service_category    String 
  service_subcategory String 

  work_description    String
  attachments         Json?
  quantity       Int                @default(1)

  address_id          String   // Int se String kiya gaya kyuki Address.address_id badal gaya hai
  address             Address  @relation(fields: [address_id], references: [address_id])
  scheduled_date      DateTime
  preferred_time      String
  order_status        String   @default("pending")
  
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt
}

model Otp {
  id        String   @id @default(cuid()) // Int se String (cuid)
  phone     String   @unique
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model AllowedNumber {
  id           String   @id @default(cuid()) // Int se String (cuid)
  phone_number String   @unique
  member_id    String?
  member       Member?  @relation(fields: [member_id], references: [member_id])
  user_id      String
  user         User     @relation(fields: [user_id], references: [user_id])
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@index([phone_number])
}

//  Enum for Service Modes
enum ServiceMode {
  REPAIR
  INSTALLATION
  GENERAL
  OUTSTATION
  IN_CITY
  WOMEN
  MEN
  S2S
  MEDICAL
  URGENT
}

//  Main Category Table
model ServiceCategory {
  id            String               @id @default(cuid())
  name          String
  slug          String               @unique // e.g., 'electrician'
  image_uri     String
  sub_categories ServiceSubCategory[]
  created_at    DateTime             @default(now())
}

//  Sub-Category Table
model ServiceSubCategory {
  id          String          @id @default(cuid())
  name        String
  mode        ServiceMode     @default(GENERAL)
  price       Float           @default(0.0) // Naya column price ke liye
  image_uri    String?
  category_id String
  category    ServiceCategory @relation(fields: [category_id], references: [id], onDelete: Cascade)
  sub_sub_categories ServiceSubSubCategory[]
  wishlist_items Wishlist[]
  cart_items     Cart[] 
  created_at  DateTime        @default(now())
}
model ServiceSubSubCategory {
  id             String             @id @default(cuid())
  name           String
  price          Float              @default(0.0) // Specific item price
  image_uri      String?
  subcategory_id String
  subcategory    ServiceSubCategory @relation(fields: [subcategory_id], references: [id], onDelete: Cascade)

  created_at     DateTime           @default(now())
  updated_at     DateTime           @updatedAt

  @@index([subcategory_id])
}
model Wishlist {
  id             String             @id @default(cuid())
  user_id        String
  user           User               @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  subcategory_id String
  subcategory    ServiceSubCategory @relation(fields: [subcategory_id], references: [id], onDelete: Cascade)

  created_at     DateTime           @default(now())

  // Ek user ek service ko ek hi baar wishlist kar sake
  @@unique([user_id, subcategory_id])
  @@index([user_id])
}

model Cart {
  id             String             @id @default(cuid())
  user_id        String
  user           User               @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  subcategory_id String
  subcategory    ServiceSubCategory @relation(fields: [subcategory_id], references: [id], onDelete: Cascade)
  quantity       Int                @default(1)

  scheduled_date   DateTime
  preferred_time   String
  work_description String?          @default("")
  attachments      Json?

  created_at     DateTime           @default(now())
  updated_at     DateTime           @updatedAt

  @@unique([user_id, subcategory_id, work_description])
}
